# nnUNet Liver Segmentation  

This Docker image runs the **StarModel pipeline** for the nnUNet-based liver segmentation framework.  
The nnUNet Analyzer automatically handles medical image data preprocessing, runs 3D segmentation using pretrained nnUNet models, and converts the predicted NIfTI segmentations back into DICOM SEG format for clinical interoperability.  

The module supports **single-modality input** and is fully integrated into the FLAME ecosystem through the `StarAnalyzer` and `StarAggregator` interfaces.
 

---

## ğŸ“‚ Input Data  

The pipeline receives its input directly from the **FLAME platform** via the `StarAnalyzer` interface.  
All input files are automatically extracted into the `/nnUNet_input` directory during runtime.  

The analyzer supports:
- **Raw bytes** (binary image data)
- **`.tar` archives** containing DICOM and/or NIfTI files  

Example structure:

```
images.tar
â”œâ”€â”€ dicom_case_1/
â”‚ â”œâ”€â”€ IM0001.dcm
â”‚ â”œâ”€â”€ IM0002.dcm
â”‚ â””â”€â”€ ...
â”œâ”€â”€ dicom_case_2/
â”‚ â”œâ”€â”€ IM0001.dcm
â”‚ â”œâ”€â”€ IM0002.dcm
â”‚ â””â”€â”€ ...
â””â”€â”€ nifti_case_1.nii.gz
```

**Note:**  
NIfTI files are copied directly.  
DICOM files are converted to NIfTI before segmentation.

---

## âš™ï¸ Parameters  

The following parameters are set inside the Docker image for this workflow. nnUNet requires these directory paths exactly as defined.

| Parameter             | Type    | Fixed Value            | Description |
|-----------------------|---------|------------------------|-------------|
| `task_name`           | str     | `"Task029_LiTS"`       | Predefined nnUNet task name; corresponds to a pretrained 3D liver segmentation model |
| `multi_modal`         | bool    | `False`                | Indicates that only a single input modality is used |
| `nnUNet_input`        | str     | `/nnUNet_input`        | Directory where all input data is extracted during runtime |
| `nnUNet_output`       | str     | `/nnUNet_output`       | Directory for all temporary and final outputs |


### Usage

The pipeline automatically:
1. Extracts all input files (supports multiple `.tar` archives).  
2. Copies NIfTI files and converts DICOM to NIfTI (if present).  
3. Runs nnUNet segmentation using pretrained models.  
4. Converts predicted NIfTI segmentations to DICOM SEG when DICOM reference metadata is available.  
5. Returns NIfTI segmentations as fallback for cases without matching DICOM metadata.  
6. Cleans up intermediate files.  

---

## ğŸ“¦ Output  

The pipeline returns a dictionary with the following structure:

```json
{
  "status": "done",
  "dicom_seg_bytes": {
    "dicom_case_1.dcm": "base64-encoded-bytes",
    "dicom_case_2.dcm": "base64-encoded-bytes"
  },
  "nifti_seg_bytes": {
    "nifti_case_1.nii.gz": "base64-encoded-bytes"
  }
}
```

Each DICOM SEG file corresponds to a segmentation result generated by nnUNet.
The segmentations are compliant with the DICOM-SEG standard.
The `nifti_seg_bytes` contain fallback NIfTI segmentations for predictions without matching DICOM SEG metadata.

**Important**: The dicom_seg_bytes are raw bytes and cannot be directly opened in MITK, 3D Slicer, or any other DICOM viewer.
To visualize the segmentations, the bytes must first be written to disk as .dcm files.

A minimal example of saving one DICOM SEG and one NIfTI segmentation locally:

```python
import pickle

# Load pipeline output
with open("/path/to/results.pkl", "rb") as f:
    data = pickle.load(f)

# Save the first segmentation
key = list(data[0]['dicom_seg_bytes'].keys())[0]
dicom_bytes = data[0]['dicom_seg_bytes'][key]

with open("/path/to/segmentation.dcm", "wb") as f:
    f.write(dicom_bytes)

# Save the first NIfTI fallback segmentation (if available)
if data[0]['nifti_seg_bytes']:
    nii_key = list(data[0]['nifti_seg_bytes'].keys())[0]
    nii_bytes = data[0]['nifti_seg_bytes'][nii_key]
    with open(f"/path/to/{nii_key}", "wb") as f:
        f.write(nii_bytes)
```

Once saved, the .dcm file can be opened in any standard DICOM viewer.

## License   

Copyright Â© German Cancer Research Center (DKFZ), Division of Medical Image Computing (MIC).  
Please make sure that your usage of this code complies with the license:  
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://github.com/MIC-DKFZ/basic_unet_example/blob/master/LICENSE)

Modifications are included; the original license still applies to the underlying code.
